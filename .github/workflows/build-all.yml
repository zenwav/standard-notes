name: Build All Apps

on:
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows?'
        required: true
        type: boolean
        default: true
      build_linux:
        description: 'Build Linux?'
        required: true
        type: boolean
        default: true
      build_android:
        description: 'Build Android?'
        required: true
        type: boolean
        default: true

jobs:
  Desktop-Windows:
    if: ${{ inputs.build_windows == true }}
    runs-on: windows-latest
    defaults:
      run:
        working-directory: packages/desktop
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Dependencies
        run: yarn install --immutable
      
      - name: Rebuild Electron Native Modules
        run: yarn workspace @standardnotes/desktop rebuild:home-server

      - name: Build JS
        run: yarn build:desktop

      - name: Webpack
        run: yarn run webpack --config desktop.webpack.prod.js

      - name: Build & Package (Windows)
        # Using no-sign.js to bypass the custom DigiCert signing script
        # Version fetched dynamically from packages/web/package.json
        run: yarn run electron-builder --windows --x64 --publish=never --c.win.sign=./scripts/no-sign.js --c.extraMetadata.version=$(node -p "require('./../web/package.json').version")
      
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: |
            packages/desktop/dist/*.exe
            packages/desktop/dist/*.blockmap

  Desktop-Linux:
    if: ${{ inputs.build_linux == true }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/desktop
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install FPM
        run: sudo gem install fpm -f

      - name: Set Version from Web Package
        run: |
          APP_VERSION=$(node -p "require('./../web/package.json').version")
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          npm version $APP_VERSION --no-git-tag-version --allow-same-version

      - name: Install Dependencies
        run: yarn install --immutable
      
      - name: Rebuild Electron Native Modules
        run: yarn workspace @standardnotes/desktop rebuild:home-server

      - name: Build JS
        run: yarn build:desktop

      - name: Webpack
        run: yarn run webpack --config desktop.webpack.prod.js

      - name: Build & Package (AppImage)
        run: yarn run electron-builder --linux --x64 -c.linux.target=AppImage --publish=never
      
      - name: Build & Package (Deb)
        run: yarn run electron-builder --linux --x64 -c.linux.target=deb --publish=never

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: |
            packages/desktop/dist/*.AppImage
            packages/desktop/dist/*.deb

  Mobile-Android:
    if: ${{ inputs.build_android == true }}
    runs-on: ubuntu-latest
    outputs:
      fdroid_version: ${{ steps.fdroid_meta.outputs.fdroid_version }}
    defaults:
      run:
        working-directory: packages/mobile
    env:
      ANDROID_KEYSTORE_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
      ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: F-Droid Preparation (Metadata & Patches)
        id: fdroid_meta
        run: |
          # 1. Fetch F-Droid Data (Clone)
          echo "Cloning F-Droid data..."
          git clone --depth 1 --filter=blob:none --sparse https://gitlab.com/fdroid/fdroiddata.git fdroid_temp
          cd fdroid_temp
          git sparse-checkout set metadata/com.standardnotes
          cd ..
          
          # 2. Extract Metadata
          METADATA_FILE="fdroid_temp/metadata/com.standardnotes.yml"
          VERSION=$(grep "CurrentVersion:" "$METADATA_FILE" | tail -n 1 | awk '{print $2}')
          VERCODE=$(grep "CurrentVersionCode:" "$METADATA_FILE" | tail -n 1 | awk '{print $2}')
          echo "FDROID_VERSION=$VERSION" >> $GITHUB_ENV
          echo "fdroid_version=$VERSION" >> $GITHUB_OUTPUT
          echo "FDROID_VERCODE=$VERCODE" >> $GITHUB_ENV
          echo "Using Version: $VERSION ($VERCODE)"

          # 3. Modify package.json (Remove IAP/Store Review)
          # We are in packages/mobile
          echo "Removing dependencies from package.json..."
          tmpfile=$(mktemp)
          cp package.json "$tmpfile"
          jq -r 'del(.devDependencies["react-native-iap"]) | del (.dependencies["react-native-store-review"])' "$tmpfile" > package.json
          rm "$tmpfile"

          # 4. Apply Patches
          echo "Finding and Applying patches..."
          # Go to root for patching
          cd ../..
          USER_WORKSPACE=$(pwd)
          
          # Find patches in the cloned directory (absolute path or relative to where we are)
          # We need to look inside packages/mobile/fdroid_temp/metadata/com.standardnotes (since we cloned it inside packages/mobile)
          PATCH_DIR="$USER_WORKSPACE/packages/mobile/fdroid_temp/metadata/com.standardnotes"
          
          # Find patches matching the simpler criteria
          find "$PATCH_DIR" -name "remove-IAP*.patch" -o -name "remove-react-native-store-review*.patch" | while read patch_file; do
            echo "Applying patch: $patch_file"
            # Try applying with patch -p1 (usually correct for root-relative patches)
            # F-Droid patches often strip 1 level if generated from root
            if patch -p1 < "$patch_file"; then
                echo "Successfully applied $patch_file"
            else
                echo "Failed to apply $patch_file with -p1, trying -p0"
                if patch -p0 < "$patch_file"; then
                     echo "Successfully applied $patch_file with -p0"
                else
                     echo "Error applying $patch_file"
                     exit 1
                fi
            fi
          done

          # Cleanup
          rm -rf "$USER_WORKSPACE/packages/mobile/fdroid_temp"

      - name: Install Dependencies
        run: yarn install --no-immutable
      
      - name: Apply F-Droid Hacks (Sed & Stripping)
        run: |
          VERSION=${{ env.FDROID_VERSION }}
          VERCODE=${{ env.FDROID_VERCODE }}
          
          # We are in packages/mobile
          cd android/app
          
          echo "Modifying build.gradle..."
          # Fix signing config: Remove the DETOX_CI check so it always uses signingConfigs.release
          sed -i -e "s/System.getenv('DETOX_CI') ? signingConfigs.debug : //" build.gradle
          # Remove Detox dependencies and proguard rules specifically
          sed -i -e '/com.wix:detox/d' -e '/detox\/proguard-rules-app.pro/d' build.gradle
          # Remove GMS and update versions
          sed -i -e '/gms/d' -e "s/versionName appVersionName/versionName \"$VERSION\"/" -e "s/versionCode appVersionCode/versionCode $VERCODE/" -e '/universalApk/s/false/true/' build.gradle
          
          echo "Removing Fido2Api..."
          rm -f src/main/java/com/standardnotes/Fido2Api*.java
          sed -i -e '/Fido2ApiPackage/d' src/main/java/com/standardnotes/MainApplication.kt
          
          echo "Patching Fingerprint Scanner..."
          pushd ../../node_modules/react-native-fingerprint-scanner/android
          sed -i -e '/FingerprintIdentify/d' build.gradle
          sed -i -e '/getFingerprintIdentify() {/,/^    }/d' -e '/resumeIdentify/,/^    }/c}' -e '/legacyGetErrorMessage() {/,/^    }/d' -e 's/legacyGetErrorMessage()/"LegacyAndroid"/g' -e '/FingerprintIdentify/Id' src/main/java/com/hieuvp/fingerprint/ReactNativeFingerprintScannerModule.java
          popd
          
          echo "Patching Web Source..."
          cd ../../../..
          # Now in root
          sed -i -e 's/&& !isAndroid()//' packages/web/src/javascripts/Components/ChallengeModal/U2FPrompt.tsx

      - name: Build Mobile JS Bundle
        run: yarn build:mobile

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.keystore
      
      - name: Build Android Release APK
        working-directory: packages/mobile/android
        run: ./gradlew assembleRelease

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-android
          path: packages/mobile/android/app/build/outputs/apk/prod/release/*.apk

  Release:
    needs: [Desktop-Windows, Desktop-Linux, Mobile-Android]
    if: ${{ !cancelled() && !failure() }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Get Versions
        id: versions
        run: |
          # 1. Desktop Version (from web/package.json)
          D_VER=$(node -p "require('./packages/web/package.json').version")
          echo "DESKTOP_VERSION=$D_VER" >> $GITHUB_ENV
          
          # 2. Android Version (from F-Droid output) - might be empty if skipped
          A_VER="${{ needs.Mobile-Android.outputs.fdroid_version }}"
          echo "ANDROID_VERSION=$A_VER" >> $GITHUB_ENV
          
      - name: Determine Release Name
        id: names
        run: |
          D_VER="${{ env.DESKTOP_VERSION }}"
          A_VER="${{ env.ANDROID_VERSION }}"
          
          # Default fallback
          RELEASE_TITLE="Release $D_VER"
          TAG_NAME="v$D_VER"

          if [[ "${{ inputs.build_windows }}" == "true" && "${{ inputs.build_linux }}" == "true" && "${{ inputs.build_android }}" == "true" ]]; then
            # Composite Build (All)
            if [[ "$D_VER" == "$A_VER" ]]; then
               RELEASE_TITLE="All - $D_VER"
            else
               RELEASE_TITLE="All - Desktop: $D_VER, Android: $A_VER"
            fi
          elif [[ "${{ inputs.build_windows }}" == "true" && "${{ inputs.build_linux }}" == "false" && "${{ inputs.build_android }}" == "false" ]]; then
            # Windows Only
            RELEASE_TITLE="Windows - $D_VER"
          elif [[ "${{ inputs.build_windows }}" == "false" && "${{ inputs.build_linux }}" == "true" && "${{ inputs.build_android }}" == "false" ]]; then
            # Linux Only
            RELEASE_TITLE="Linux - $D_VER"
          elif [[ "${{ inputs.build_windows }}" == "false" && "${{ inputs.build_linux }}" == "false" && "${{ inputs.build_android }}" == "true" ]]; then
            # Android Only
            RELEASE_TITLE="Android - $A_VER"
            TAG_NAME="v$A_VER"
          fi
          
          echo "RELEASE_NAME=$RELEASE_TITLE" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: final_artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.RELEASE_NAME }}
          draft: false
          prerelease: false
          files: |
             final_artifacts/**/*
