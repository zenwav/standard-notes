name: Build All Apps

on:
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows?'
        required: true
        type: boolean
        default: true
      build_linux:
        description: 'Build Linux?'
        required: true
        type: boolean
        default: true
      build_android:
        description: 'Build Android?'
        required: true
        type: boolean
        default: true
      version:
        description: 'Version (e.g., 3.190.0)'
        required: true
        type: string
        default: '3.190.0'

jobs:
  Desktop-Windows:
    if: ${{ inputs.build_windows == true }}
    runs-on: windows-latest
    defaults:
      run:
        working-directory: packages/desktop
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Set Version
        run: |
          npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version
      
      - name: Install Dependencies
        run: yarn install --immutable
      
      - name: Rebuild Electron Native Modules
        run: yarn workspace @standardnotes/desktop rebuild:home-server

      - name: Build JS
        run: yarn build:desktop

      - name: Webpack
        run: yarn run webpack --config desktop.webpack.prod.js

      - name: Build & Package (Windows)
        # Using no-sign.js to bypass the custom DigiCert signing script
        run: yarn run electron-builder --windows --x64 --publish=never --c.win.sign=./scripts/no-sign.js
      
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: |
            packages/desktop/dist/*.exe
            packages/desktop/dist/*.blockmap

  Desktop-Linux:
    if: ${{ inputs.build_linux == true }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/desktop
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install FPM
        run: sudo gem install fpm -f

      - name: Set Version
        run: |
          npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Install Dependencies
        run: yarn install --immutable
      
      - name: Rebuild Electron Native Modules
        run: yarn workspace @standardnotes/desktop rebuild:home-server

      - name: Build JS
        run: yarn build:desktop

      - name: Webpack
        run: yarn run webpack --config desktop.webpack.prod.js

      - name: Build & Package (AppImage)
        run: yarn run electron-builder --linux --x64 -c.linux.target=AppImage --publish=never
      
      - name: Build & Package (Deb)
        run: yarn run electron-builder --linux --x64 -c.linux.target=deb --publish=never

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: |
            packages/desktop/dist/*.AppImage
            packages/desktop/dist/*.deb

  Mobile-Android:
    if: ${{ inputs.build_android == true }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/mobile
    env:
      ANDROID_KEYSTORE_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
      ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: F-Droid Preparation (Metadata & Patches)
        run: |
          # 1. Fetch Metadata
          echo "Fetching F-Droid metadata..."
          curl -s https://gitlab.com/fdroid/fdroiddata/-/raw/master/metadata/com.standardnotes.yml -o metadata.yml
          VERSION=$(grep "CurrentVersion:" metadata.yml | head -n 1 | awk '{print $2}')
          VERCODE=$(grep "CurrentVersionCode:" metadata.yml | head -n 1 | awk '{print $2}')
          echo "FDROID_VERSION=$VERSION" >> $GITHUB_ENV
          echo "FDROID_VERCODE=$VERCODE" >> $GITHUB_ENV
          echo "Using Version: $VERSION ($VERCODE)"

          # 2. Modify package.json (Remove IAP/Store Review)
          # We are in packages/mobile
          echo "Removing dependencies from package.json..."
          tmpfile=$(mktemp)
          cp package.json "$tmpfile"
          jq -r 'del(.devDependencies["react-native-iap"]) | del (.dependencies["react-native-store-review"])' "$tmpfile" > package.json
          rm "$tmpfile"

          # 3. Fetch and Apply Patches
          echo "Fetching patches..."
          # Fetch file list
          FILES_JSON=$(curl -s "https://gitlab.com/api/v4/projects/fdroid%2Ffdroiddata/repository/tree?path=metadata/com.standardnotes")
          # Extract patch filenames
          PATCHES=$(echo "$FILES_JSON" | jq -r '.[] | select(.name | test("remove-IAP.*\\.patch|remove-react-native-store-review.*\\.patch")) | .name')
          
          # Go to root for patching
          cd ../..
          for patch in $PATCHES; do
            echo "Applying $patch..."
            curl -s "https://gitlab.com/fdroid/fdroiddata/-/raw/master/metadata/com.standardnotes/$patch" -o "$patch"
            # Try applying with git apply, fallback to patch
            git apply --ignore-space-change --ignore-whitespace "$patch" || patch -p1 < "$patch"
          done

      - name: Install Dependencies
        run: yarn install --no-immutable
      
      - name: Apply F-Droid Hacks (Sed & Stripping)
        run: |
          VERSION=${{ env.FDROID_VERSION }}
          VERCODE=${{ env.FDROID_VERCODE }}
          
          # We are in packages/mobile
          cd android/app
          
          echo "Modifying build.gradle..."
          sed -i -e '/detox/Id' -e '/gms/d' -e "s/versionName appVersionName/versionName \"$VERSION\"/" -e "s/versionCode appVersionCode/versionCode $VERCODE/" -e '/universalApk/s/false/true/' build.gradle
          
          echo "Removing Fido2Api..."
          rm -f src/main/java/com/standardnotes/Fido2Api*.java
          sed -i -e '/Fido2ApiPackage/d' src/main/java/com/standardnotes/MainApplication.kt
          
          echo "Patching Fingerprint Scanner..."
          pushd ../../node_modules/react-native-fingerprint-scanner/android
          sed -i -e '/FingerprintIdentify/d' build.gradle
          sed -i -e '/getFingerprintIdentify() {/,/^    }/d' -e '/resumeIdentify/,/^    }/c}' -e '/legacyGetErrorMessage() {/,/^    }/d' -e 's/legacyGetErrorMessage()/"LegacyAndroid"/g' -e '/FingerprintIdentify/Id' src/main/java/com/hieuvp/fingerprint/ReactNativeFingerprintScannerModule.java
          popd
          
          echo "Patching Web Source..."
          cd ../../../..
          # Now in root
          sed -i -e 's/&& !isAndroid()//' packages/web/src/javascripts/Components/ChallengeModal/U2FPrompt.tsx

      - name: Build Mobile JS Bundle
        run: yarn build:mobile

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.keystore
      
      - name: Build Android Release APK
        working-directory: packages/mobile/android
        run: ./gradlew assembleRelease

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-android
          path: packages/mobile/android/app/build/outputs/apk/prod/release/*.apk

  Release:
    needs: [Desktop-Windows, Desktop-Linux, Mobile-Android]
    if: ${{ !cancelled() && !failure() }}
    runs-on: ubuntu-latest
    steps:
      - name: Determine Release Name
        id: names
        run: |
          PLATFORM_NAME="Composite"
          if [[ "${{ inputs.build_windows }}" == "true" && "${{ inputs.build_linux }}" == "true" && "${{ inputs.build_android }}" == "true" ]]; then
            PLATFORM_NAME="All"
          elif [[ "${{ inputs.build_windows }}" == "true" && "${{ inputs.build_linux }}" == "false" && "${{ inputs.build_android }}" == "false" ]]; then
            PLATFORM_NAME="Windows"
          elif [[ "${{ inputs.build_windows }}" == "false" && "${{ inputs.build_linux }}" == "true" && "${{ inputs.build_android }}" == "false" ]]; then
            PLATFORM_NAME="Linux"
          elif [[ "${{ inputs.build_windows }}" == "false" && "${{ inputs.build_linux }}" == "false" && "${{ inputs.build_android }}" == "true" ]]; then
            PLATFORM_NAME="Android"
          fi
          echo "RELEASE_NAME=$PLATFORM_NAME - ${{ inputs.version }}" >> $GITHUB_ENV

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: final_artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: ${{ env.RELEASE_NAME }}
          draft: false
          prerelease: false
          files: |
             final_artifacts/**/*
